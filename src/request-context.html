
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Accessing Request Context Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-enhanced-katex/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="logging.html" />
    
    
    <link rel="prev" href="implicit-authentication.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="basics.html">
            
                <a href="basics.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Scaffold from scratch</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="suave.html">
            
                <a href="suave.html">
            
                    
                    Setup Suave
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="giraffe.html">
            
                <a href="giraffe.html">
            
                    
                    Setup Giraffe
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="saturn.html">
            
                <a href="saturn.html">
            
                    
                    Setup Saturn
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="client.html">
            
                <a href="client.html">
            
                    
                    Setup Client
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Advanced</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="route-builder.html">
            
                <a href="route-builder.html">
            
                    
                    Custom Route Paths
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="error-handling.html">
            
                <a href="error-handling.html">
            
                    
                    Error Handling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="modeling-authentication.html">
            
                <a href="modeling-authentication.html">
            
                    
                    Modeling Authentication
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="implicit-authentication.html">
            
                <a href="implicit-authentication.html">
            
                    
                    Implicit Authentication
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.5" data-path="request-context.html">
            
                <a href="request-context.html">
            
                    
                    Accessing Request Context
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="logging.html">
            
                <a href="logging.html">
            
                    
                    Logging
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Misc</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="troubleshoot.html">
            
                <a href="troubleshoot.html">
            
                    
                    Troubleshooting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="credits.html">
            
                <a href="credits.html">
            
                    
                    Credits
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Accessing Request Context</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="accessing-request-context">Accessing Request Context</h1>
<p>Sometimes you might need to read data from the incoming request, Maybe to validate a request header or to do some kind of logging. We will demonstrate this with Suave, the same logic follows for the other web frameworks. We also want to be able to do this without sacrificing the shape the shared interface. </p>
<p>The idea is to make the remoting handler <em>dependent</em> on the incoming request context. We do this by parameterizing the definition of the shared interface with a generic context type</p>
<pre><code class="lang-fs"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">IMusicStore</span>&lt;<span class="hljs-title">&apos;Context</span>&gt; </span>= {
    <span class="hljs-comment">/// return favorite albums of current logged in user</span>
    favoriteAlbums : &apos;Context -&gt; Async&lt;Album list&gt;
}
</code></pre>
<p>Notice the <code>&apos;Context</code> generic parameter in the definition, this type is going to be of type <code>HttpContext</code>  from Suave when we provide an implementation but we don&apos;t hardcode that fact to make the definition applicable to the different web frameworks but also to make the interface callable from a proxy on client, more on this later.  </p>
<p>Now, here is an implementation of the interface:</p>
<pre><code class="lang-fs"><span class="hljs-keyword">let</span> musicStore : IMusicStore&lt;HttpContext&gt; = {
    <span class="hljs-comment">// return favorite albums of current logged-in user</span>
    favoriteAlbums = <span class="hljs-keyword">fun</span> ctx -&gt; async {
        <span class="hljs-comment">// get the authorization header, if any</span>
        <span class="hljs-keyword">let</span> authHeader = 
            ctx.request.headers
            |&gt; List.tryFind (<span class="hljs-keyword">fun</span> (key, _) -&gt; key = <span class="hljs-string">&quot;authorization&quot;</span>)
            |&gt; Option.map snd 

        <span class="hljs-keyword">match</span> Security.extractUser authHeader <span class="hljs-keyword">with</span>
        | None -&gt; <span class="hljs-keyword">return</span> [] <span class="hljs-comment">// no albums </span>
        | Some user -&gt; 
            <span class="hljs-keyword">let!</span> favoriteAlbums = Database.favoriteAlbums user
            <span class="hljs-keyword">return</span> favoriteAlbums
    }
}
</code></pre>
<p>Now that you an implementation, you can just create the <code>WebPart</code> like you would usually do in Suave:</p>
<pre><code class="lang-fs"><span class="hljs-keyword">let</span> fableWebPart = remoting musicStore {()}

<span class="hljs-keyword">let</span> webApp = 
    choose [ 
        GET &gt;=&gt; path <span class="hljs-string">&quot;/&quot;</span> &gt;=&gt; OK <span class="hljs-string">&quot;Hello from root&quot;</span>
        fableWebPart
    ]

startWebServer defaultConfig webApp
</code></pre>
<p>But now there is a little problem: How do you call the server from the client if the functions require a <code>&apos;Context</code> as an input? Well you simply provide a <code>unit</code> as the generic parameter and everything just works out:</p>
<pre><code class="lang-fs"><span class="hljs-comment">// Client</span>

<span class="hljs-comment">// doesn&apos;t send authorization header value</span>
<span class="hljs-keyword">let</span> musicStore =  Proxy.remoting&lt;IMusicStore&lt;unit&gt;&gt; {()}

<span class="hljs-comment">// sends an authorization header with every request</span>
<span class="hljs-keyword">let</span> secureMusicStore = Proxy.remoting&lt;IMusicStore&lt;unit&gt;&gt; {
    use_token <span class="hljs-string">&quot;Bearer &lt;authorization value here&gt;&quot;</span>
} 

async {
    <span class="hljs-keyword">let!</span> favoriteAlbums = secureMusicStore.favoriteAlbums() 
    <span class="hljs-keyword">for</span> album <span class="hljs-keyword">in</span> favoriteAlbums <span class="hljs-keyword">do</span>
        printfn <span class="hljs-string">&quot;%s&quot;</span> album.Title
}
|&gt; Async.StartImmediate
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="implicit-authentication.html" class="navigation navigation-prev " aria-label="Previous page: Implicit Authentication">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="logging.html" class="navigation navigation-next " aria-label="Next page: Logging">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Accessing Request Context","level":"3.5","depth":1,"next":{"title":"Logging","level":"3.6","depth":1,"path":"src/logging.md","ref":"src/logging.md","articles":[]},"previous":{"title":"Implicit Authentication","level":"3.4","depth":1,"path":"src/implicit-authentication.md","ref":"src/implicit-authentication.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["enhanced-katex"],"pluginsConfig":{"enhanced-katex":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css"}},"file":{"path":"src/request-context.md","mtime":"2018-03-28T18:55:43.353Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-03-30T17:43:40.591Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

